{% extends "admin/admin_layout.html" %}
{% block title %}分类管理{% endblock %}
{% block content %}
<div class="card">
  <h2>分类管理</h2>

  <div style="margin-bottom:20px;">
    <button onclick="showAddModal()" class="btn btn-success">新增分类</button>
  </div>

  <table>
    <thead>
      <tr>
        <th>ID</th>
        <th>名称</th>
        <th>排序</th>
        <th>状态</th>
        <th>操作</th>
      </tr>
    </thead>
    <tbody>
      {% for c in categories %}
      <tr>
        <td>{{ c.cate_id }}</td>
        <td>{{ c.name }}</td>
        <td>{{ c.sort }}</td>
        <td>{{ '启用' if c.enabled else '禁用' }}</td>
        <td>
  <button class="btn btn-small" 
          data-id="{{ c.cate_id }}" 
          data-name="{{ c.name }}" 
          data-sort="{{ c.sort }}" 
          data-enabled="{{ c.enabled }}"
          onclick="editCat(this)">编辑</button>
  <button class="btn btn-danger btn-small" onclick="deleteCat({{ c.cate_id }})">删除</button>
</td>
      </tr>
      {% else %}
      <tr><td colspan="5" style="text-align:center; color:#999; padding:40px;">暂无分类</td></tr>
      {% endfor %}
    </tbody>
  </table>
</div>

<!-- 模态框（简单JS实现） -->
<div id="modal" style="display:none; position:fixed; top:0; left:0; right:0; bottom:0; background:rgba(0,0,0,0.5); justify-content:center; align-items:center;">
  <div style="background:white; padding:30px; border-radius:12px; width:400px;">
    <h3 id="modal-title">新增分类</h3>
    <input type="hidden" id="cat_id">
    <div style="margin:15px 0;">
      <label>名称：</label>
      <input type="text" id="cat_name" style="width:100%; padding:10px; margin-top:5px;">
    </div>
    <div style="margin:15px 0;">
      <label>排序：</label>
      <input type="number" id="cat_sort" value="0" style="width:100%; padding:10px; margin-top:5px;">
    </div>
    <div style="margin:15px 0;">
      <label><input type="checkbox" id="cat_enabled" checked> 启用</label>
    </div>
    <div style="text-align:right;">
      <button onclick="closeModal()" class="btn">取消</button>
      <button onclick="saveCat()" class="btn btn-success">保存</button>
    </div>
  </div>
</div>

<script>
function showAddModal() {
  document.getElementById('modal-title').textContent = '新增分类';
  document.getElementById('cat_id').value = '';
  document.getElementById('cat_name').value = '';
  document.getElementById('cat_sort').value = '0';
  document.getElementById('cat_enabled').checked = true;
  document.getElementById('modal').style.display = 'flex';
}

function editCat(btn) {
  document.getElementById('modal-title').textContent = '编辑分类';
  document.getElementById('cat_id').value = btn.dataset.id;
  document.getElementById('cat_name').value = btn.dataset.name;
  document.getElementById('cat_sort').value = btn.dataset.sort;
  document.getElementById('cat_enabled').checked = btn.dataset.enabled == '1';
  document.getElementById('modal').style.display = 'flex';
}

function closeModal() {
  document.getElementById('modal').style.display = 'none';
}

async function saveCat() {
  const id = document.getElementById('cat_id').value;
  const name = document.getElementById('cat_name').value.trim();
  if (!name) {
    alert('分类名称不能为空');
    return;
  }

  const data = {
    name: name,
    sort: parseInt(document.getElementById('cat_sort').value) || 0,
    enabled: document.getElementById('cat_enabled').checked ? 1 : 0
  };

  if (id) {
    data.cate_id = id;
    data.action = 'edit';
  } else {
    data.action = 'add';
  }

  try {
    const res = await fetch('/admin/category', {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify(data)
    });
    const d = await res.json();
    alert(d.msg);
    if (d.code === 200) {
      location.reload();
    }
  } catch (err) {
    alert('网络错误，请重试');
  }
}

async function deleteCat(id) {
  if (!confirm('确定删除该分类？关联商品将无法显示！')) return;

  try {
    const res = await fetch('/admin/category', {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify({action: 'delete', cate_id: id})
    });
    const d = await res.json();
    alert(d.msg);
    if (d.code === 200) {
      location.reload();
    }
  } catch (err) {
    alert('网络错误，请重试');
  }
}
</script>
{% endblock %}