{% extends "admin/admin_layout.html" %}
{% block title %}商品管理{% endblock %}
{% block content %}
<div class="card">
  <h2>商品管理</h2>
  <div class="search-bar">
    <form method="get">
      <input type="text" name="keyword" placeholder="搜索商品标题..." value="{{ keyword or '' }}">
      <button type="submit" class="btn btn-success">搜索</button>
    </form>
  </div>

  <table>
    <thead>
      <tr>
        <th>ID</th>
        <th>标题</th>
        <th>价格</th>
        <th>卖家</th>
        <th>上架时间</th>
        <th>状态</th>
        <th>操作</th>
      </tr>
    </thead>
    <tbody>
  {% if goods %}
    {% for g in goods %}
    <tr>
      <td>{{ g.goods_id }}</td>
      <td><a href="/goods/{{ g.goods_id }}" target="_blank">{{ g.title }}</a></td>
      <td>¥ {{ "%.2f"|format(g.price) }}</td>
      <td>{{ g.seller_nick }}</td>
      <td>{{ g.on_shelf_time.strftime('%Y-%m-%d %H:%M') if g.on_shelf_time else '未知' }}</td>
      <td>
        <span style="color:{{ '#27ae60' if g.status == 1 else '#e74c3c' }}; font-weight:bold;">
          {{ '在售' if g.status == 1 else '已下架' }}
        </span>
      </td>
      <td>
        {% if g.status == 1 %}
        <button class="btn btn-warning btn-small" onclick="offGoods({{ g.goods_id }})">下架</button>
        {% endif %}
        <button class="btn btn-danger btn-small" onclick="deleteGoods({{ g.goods_id }})">删除</button>
      </td>
    </tr>
    {% endfor %}
  {% else %}
    <tr><td colspan="7" style="text-align:center; color:#999; padding:60px;">暂无商品记录</td></tr>
  {% endif %}
</tbody>
  </table>

  <!-- 分页 -->
  {% if pagination.pages > 1 %}
  <div style="text-align:center; margin-top:30px;">
    {% if pagination.has_prev %}
    <a href="?page={{ pagination.prev_num }}&keyword={{ keyword or '' }}" class="btn">上一页</a>
    {% endif %}
    <span style="margin:0 20px;">第 {{ pagination.page }} / {{ pagination.pages }} 页</span>
    {% if pagination.has_next %}
    <a href="?page={{ pagination.next_num }}&keyword={{ keyword or '' }}" class="btn">下一页</a>
    {% endif %}
  </div>
  {% endif %}
</div>

<script>
async function offGoods(id) {
  if (!confirm('确定下架该商品？下架后用户将看不到')) return;

  try {
    const res = await fetch('/admin/goods/action', {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify({goods_id: id, action: 'offshelf'})
    });
    const d = await res.json();
    alert(d.msg);
    if (d.code === 200) {
      location.reload();
    }
  } catch (err) {
    alert('网络错误，请刷新重试');
  }
}

async function deleteGoods(id) {
  if (!confirm('确定永久删除该商品？删除后不可恢复！')) return;

  try {
    const res = await fetch('/admin/goods/action', {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify({goods_id: id, action: 'delete'})
    });
    const d = await res.json();
    alert(d.msg);
    if (d.code === 200) {
      location.reload();
    }
  } catch (err) {
    alert('网络错误，请刷新重试');
  }
}
</script>
{% endblock %}